//Revision por redundancia
import prisma from "../database.js";

export default class DetallesAvaluosController {
  static async getAll(_req, res) {
    try {
      const detalles = await prisma.detalles_avaluos.findMany({
        where: { fecha_eliminacion: null },
        include: {
          avaluos: { select: { avaluo_id: true, descripcion: true } },
          productos: { select: { producto_id: true, nombre_producto: true, precio_unitario: true } },
        },
        orderBy: { detalle_avaluo_id: "asc" },
      });
      res.json({ ok: true, data: detalles });
    } catch (error) {
      console.error(error);
      res.status(500).json({ ok: false, msg: "Server error, something went wrong" });
    }
  }

  static async getById(req, res) {
    const id = parseInt(req.params.id);
    if (isNaN(id))
      return res.status(400).json({ ok: false, msg: "El ID del detalle debe ser un número" });

    try {
      const detalle = await prisma.detalles_avaluos.findFirst({
        where: { AND: [{ detalle_avaluo_id: id }, { fecha_eliminacion: null }] },
        include: {
          avaluos: { select: { avaluo_id: true, descripcion: true } },
          productos: { select: { producto_id: true, nombre_producto: true } },
        },
      });
      if (!detalle)
        return res.status(404).json({ ok: false, msg: `No se encontró el detalle con ID: ${id}` });
      res.json({ ok: true, data: detalle });
    } catch (error) {
      console.error(error);
      res.status(500).json({ ok: false, msg: "Server error, something went wrong" });
    }
  }

  static async create(req, res) {
    try {
      const { avaluo_id, producto_id, cantidad, precio_unitario, descripcion } = req.body;
      if (!avaluo_id || !producto_id || cantidad == null || precio_unitario == null) {
        return res.status(400).json({
          ok: false,
          msg: "Campos obligatorios: avaluo_id, producto_id, cantidad, precio_unitario",
        });
      }

      const avalOk = await prisma.avaluos.findFirst({
        where: { AND: [{ avaluo_id: parseInt(avaluo_id) }, { fecha_eliminacion: null }] },
      });
      if (!avalOk) return res.status(400).json({ ok: false, msg: "El avalúo especificado no existe o fue eliminado" });

      const prodOk = await prisma.productos.findFirst({
        where: { AND: [{ producto_id: parseInt(producto_id) }, { fecha_eliminacion: null }] },
      });
      if (!prodOk) return res.status(400).json({ ok: false, msg: "El producto especificado no existe o fue eliminado" });

      const detalle = await prisma.detalles_avaluos.create({
        data: {
          avaluo_id: parseInt(avaluo_id),
          producto_id: parseInt(producto_id),
          cantidad: parseInt(cantidad),
          precio_unitario: parseFloat(precio_unitario),
          descripcion: descripcion?.trim() ?? null,
        },
      });

      await DetallesAvaluosController.actualizarMontoAvaluo(parseInt(avaluo_id));

      res.status(201).json({ ok: true, msg: "Detalle creado correctamente", data: detalle });
    } catch (error) {
      console.error(error);
      res.status(500).json({ ok: false, msg: "Server error, something went wrong" });
    }
  }

  static async update(req, res) {
    const id = parseInt(req.params.id);
    if (isNaN(id))
      return res.status(400).json({ ok: false, msg: "El ID del detalle debe ser un número" });

    try {
      const old = await prisma.detalles_avaluos.findUnique({ where: { detalle_avaluo_id: id } });
      if (!old || old.fecha_eliminacion !== null)
        return res.status(404).json({ ok: false, msg: "No se encontró el detalle a modificar" });

      const { avaluo_id, producto_id, cantidad, precio_unitario, descripcion } = req.body;

      const detalle = await prisma.detalles_avaluos.update({
        where: { detalle_avaluo_id: id },
        data: {
          avaluo_id: avaluo_id ? parseInt(avaluo_id) : old.avaluo_id,
          producto_id: producto_id ? parseInt(producto_id) : old.producto_id,
          cantidad: cantidad != null ? parseInt(cantidad) : old.cantidad,
          precio_unitario: precio_unitario != null ? parseFloat(precio_unitario) : old.precio_unitario,
          descripcion: descripcion?.trim() ?? old.descripcion,
          fecha_actualizacion: new Date(),
        },
      });

      await DetallesAvaluosController.actualizarMontoAvaluo(detalle.avaluo_id);

      res.json({ ok: true, msg: "Detalle actualizado correctamente", data: detalle });
    } catch (error) {
      console.error(error);
      res.status(500).json({ ok: false, msg: "Server error, something went wrong" });
    }
  }

  static async delete(req, res) {
    const id = parseInt(req.params.id);
    if (isNaN(id))
      return res.status(400).json({ ok: false, msg: "El ID del detalle debe ser un número" });

    try {
      const existe = await prisma.detalles_avaluos.findFirst({
        where: { AND: [{ detalle_avaluo_id: id }, { fecha_eliminacion: null }] },
      });
      if (!existe)
        return res.status(404).json({ ok: false, msg: "No se encontró el detalle a eliminar" });

      const { detalle_avaluo_id, avaluo_id } = await prisma.detalles_avaluos.update({
        where: { detalle_avaluo_id: id },
        data: { fecha_eliminacion: new Date() },
      });

      await DetallesAvaluosController.actualizarMontoAvaluo(avaluo_id);

      res.json({ ok: true, msg: "Detalle eliminado correctamente", id: detalle_avaluo_id });
    } catch (error) {
      console.error(error);
      res.status(500).json({ ok: false, msg: "Server error, something went wrong" });
    }
  }

  static async actualizarMontoAvaluo(avaluoId) {
    try {
      const detalles = await prisma.detalles_avaluos.findMany({
        where: { avaluo_id: avaluoId, fecha_eliminacion: null },
      });

      const total = detalles.reduce(
        (sum, d) => sum + Number(d.cantidad) * Number(d.precio_unitario),
        0
      );

      await prisma.avaluos.update({
        where: { avaluo_id: avaluoId },
        data: { monto_ejecutado: total, fecha_actualizacion: new Date() },
      });
    } catch (error) {
      console.error("Error al recalcular monto del avalúo:", error);
    }
  }
}
